# 데이터베이스 스키마 명세서

## 1. 기능 목적과 개요
### 1.1 목적
  - 데이터 구조 정의
  - 데이터 무결성 보장
  - 효율적인 데이터 접근

### 1.2 개요
  - PostgreSQL 데이터베이스 사용
  - Prisma ORM 활용
  - 관계형 데이터베이스 설계

## 2. 상세 구현 요구사항
### 2.1 사용자 관련 테이블
  ```prisma
  // schema.prisma
  model User {
    id        String   @id @default(cuid())
    email     String   @unique
    name      String
    contact   String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // 관계
    roles     UserRole[]
    farms     Farm[]
    jobs      JobPosting[]
    matches   Match[]
  }

  model UserRole {
    id        String   @id @default(cuid())
    userId    String
    role      Role     @default(WORKER)
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // 관계
    user      User     @relation(fields: [userId], references: [id])

    @@index([userId, role])
  }

  enum Role {
    FARMER
    WORKER
  }
  ```

### 2.2 농장 관련 테이블
  ```prisma
  model Farm {
    id          String   @id @default(cuid())
    ownerId     String
    name        String
    description String?
    latitude    Float
    longitude   Float
    address     String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // 관계
    owner       User     @relation(fields: [ownerId], references: [id])
    jobs        JobPosting[]

    @@index([ownerId])
    @@index([latitude, longitude])
  }
  ```

### 2.3 구인구직 관련 테이블
  ```prisma
  model JobPosting {
    id          String   @id @default(cuid())
    type        JobType
    userId      String
    farmId      String?
    title       String
    description String
    workDate    WorkDate
    payment     Payment
    status      JobStatus @default(OPEN)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    // 관계
    user        User      @relation(fields: [userId], references: [id])
    farm        Farm?     @relation(fields: [farmId], references: [id])
    matches     Match[]

    @@index([userId])
    @@index([farmId])
    @@index([status])
  }

  enum JobType {
    FARMER  // 오세요
    WORKER  // 갈게요
  }

  enum JobStatus {
    OPEN
    CLOSED
    COMPLETED
  }

  type WorkDate {
    start DateTime
    end   DateTime
  }

  type Payment {
    amount Int
    unit   PaymentUnit
  }

  enum PaymentUnit {
    DAY
    HOUR
  }
  ```

### 2.4 매칭 관련 테이블
  ```prisma
  model Match {
    id           String      @id @default(cuid())
    jobPostingId String
    workerId     String
    status       MatchStatus @default(PENDING)
    message      String?
    appliedAt    DateTime    @default(now())
    updatedAt    DateTime    @updatedAt
    completedAt  DateTime?

    // 관계
    jobPosting   JobPosting  @relation(fields: [jobPostingId], references: [id])
    worker       User        @relation(fields: [workerId], references: [id])

    @@index([jobPostingId])
    @@index([workerId])
    @@index([status])
  }

  enum MatchStatus {
    PENDING
    ACCEPTED
    REJECTED
    COMPLETED
  }
  ```

## 3. 데이터베이스 인터페이스
### 3.1 Prisma Client 설정
  ```typescript
  // lib/prisma.ts
  import { PrismaClient } from '@prisma/client';

  declare global {
    var prisma: PrismaClient | undefined;
  }

  export const prisma = global.prisma || new PrismaClient();

  if (process.env.NODE_ENV !== 'production') {
    global.prisma = prisma;
  }
  ```

### 3.2 데이터 접근 패턴
  ```typescript
  // 트랜잭션 예시
  async function createJobWithFarm(data: JobWithFarmData) {
    return await prisma.$transaction(async (tx) => {
      const farm = await tx.farm.create({
        data: data.farm
      });
      
      return await tx.jobPosting.create({
        data: {
          ...data.job,
          farmId: farm.id
        }
      });
    });
  }
  ```

## 4. 연관 기능들과의 관계
### 4.1 인증/인가
  - 사용자 정보 관리
  - 역할 기반 접근 제어

### 4.2 구인구직
  - 농장-구인글 연관 관계
  - 상태 관리

### 4.3 매칭
  - 구인글-지원 연관 관계
  - 매칭 이력 관리

## 5. 제약사항 및 고려사항
### 5.1 데이터 무결성
  - 외래키 제약조건
  - 유니크 제약조건
  - NULL 제약조건

### 5.2 성능
  - 인덱스 설계
  - 쿼리 최적화
  - 캐싱 전략

### 5.3 확장성
  - 스키마 마이그레이션
  - 데이터 백업
  - 샤딩 고려

### 5.4 보안
  - 데이터 암호화
  - 접근 제어
  - 감사 로깅 